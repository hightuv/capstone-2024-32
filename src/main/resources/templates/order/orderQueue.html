<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ===== Link Swiper's CSS ===== -->
    <link rel="stylesheet" th:href="@{https://unpkg.com/swiper/swiper-bundle.min.css}" />
    <!-- ===== Fontawesome CDN Link ===== -->
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css}" />
    <!-- ===== CSS ===== -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <!-- ==== JS ===== -->
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <title>주문 대기열</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f8f9fa; /* 배경색 설정 (선택 사항) */
        }

        .swiper-container {
            width: 100%;
            height: 100%; /* 전체 화면 크기로 조정 */
            padding: 20px;
            box-sizing: border-box;
        }

        .swiper-slide {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%; /* 전체 화면 크기로 조정 */
            height: auto; /* 내용에 맞게 높이 자동 조정 */
        }

        .card-content {
            width: 40%; /* 화면의 40% 차지 */
            min-width: 280px; /* 최소 너비 */
            padding: 20px;
            border: 2px solid #ccc;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            background-color: #fff; /* 카드 배경색 */
        }

        .btn {
            margin-top: 10px;
            width: 100px;
        }
    </style>
</head>
<body>
<div class="swiper-container">
    <div class="swiper-wrapper" id="queueContainer"></div>

    <!-- Pagination -->
    <div class="swiper-pagination"></div>

    <!-- Navigation Buttons -->
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
</div>

<script th:inline="javascript">
    var swiper = new Swiper('.swiper-container', {
        slidesPerView: 1,
        spaceBetween: 30,
        loop: true,
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
    });

    // WebSocket 연결 및 메시지 수신 처리
    function connect() {
        let socket = new SockJS('/ws');
        let stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/queue', function(message) {
                let orders = JSON.parse(message.body);
                displayOrder(orders);
            });
        });
    }

    // 주문 정보를 화면에 표시하는 함수
    function displayOrder(orders) {
        document.getElementById('queueContainer').innerHTML = '';
        let queueContainer = document.getElementById('queueContainer');

        orders.forEach(order => {
            // 주문 카드 생성
            let cardDiv = document.createElement('div');
            cardDiv.classList.add('card-content');

            // 카드 내용 구성
            let seatHeader = document.createElement('h4');
            seatHeader.textContent = order.seatName;
            cardDiv.appendChild(seatHeader);

            let statusHeader = document.createElement('h5');
            statusHeader.textContent = order.orderStatus;
            cardDiv.appendChild(statusHeader);

            let orderContent = document.createElement('p');
            orderContent.classList.add('order-content');
            orderContent.textContent = order.orderItems;
            cardDiv.appendChild(orderContent);

            // 주문 취소, 진행 중, 완료 버튼 생성
            let cancelBtn = createButton('btn btn-danger', '취소', () => cancelOrder(order.id));
            let progressBtn = createButton('btn btn-warning', '진행중', () => progressOrder(order.id));
            let completeBtn = createButton('btn btn-success', '완료', () => completeOrder(order.id));

            // 카드에 버튼 추가
            cardDiv.appendChild(cancelBtn);
            cardDiv.appendChild(progressBtn);
            cardDiv.appendChild(completeBtn);

            // 새로운 주문 정보를 슬라이드에 추가
            queueContainer.appendChild(cardDiv);
        });
        // Swiper 슬라이드 업데이트
        swiper.update(); // Swiper 업데이트
    }

    // 버튼 생성을 위한 도우미 함수
    function createButton(className, text, onClickHandler) {
        let button = document.createElement('button');
        button.classList.add(className);
        button.textContent = text;
        button.onclick = onClickHandler;
        return button;
    }

    // 주문 상태 변경 함수
    function sendOrderAction(orderId, action) {
        let socket = new SockJS('/ws');
        let stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            stompClient.send('/app/updateOrderStatus', {}, JSON.stringify({
                'orderId': orderId,
                'action': action
            }));
            stompClient.disconnect();
        });
    }

    // 취소 버튼 클릭 시
    function cancelOrder(orderId) {
        sendOrderAction(orderId, '취소');
    }

    // 진행중 버튼 클릭 시
    function progressOrder(orderId) {
        sendOrderAction(orderId, '진행중');
    }

    // 완료 버튼 클릭 시
    function completeOrder(orderId) {
        sendOrderAction(orderId, '완료');
    }

    // 페이지 로드 시 WebSocket 연결
    connect();
</script>

</body>
</html>